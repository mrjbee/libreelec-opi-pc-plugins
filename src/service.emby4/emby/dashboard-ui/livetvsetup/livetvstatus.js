define(["globalize","scripts/taskbutton","dom","libraryMenu","layoutManager","loading","listViewStyle","flexStyles","emby-itemscontainer","cardStyle","material-icons","emby-linkbutton","emby-button"],function(globalize,taskButton,dom,libraryMenu,layoutManager,loading){"use strict";function getDeviceHtml(device){var padderClass,html="",cssClass="card scalableCard",cardBoxCssClass="cardBox visualCardBox";return cssClass+=" backdropCard backdropCard-scalable",padderClass="cardPadder-backdrop",layoutManager.tv&&(cssClass+=" card-focusscale",cardBoxCssClass+=" cardBox-focustransform"),cardBoxCssClass+=" card-focuscontent",html+='<div type="button" class="'+cssClass+'" data-id="'+device.Id+'">',html+='<div class="'+cardBoxCssClass+'">',html+='<div class="cardScalable visualCardBox-cardScalable">',html+='<div class="'+padderClass+'"></div>',html+='<div class="cardContent searchImage">',html+='<div class="cardImageContainer coveredImage"><i class="cardImageIcon md-icon">dvr</i></div>',html+="</div>",html+="</div>",html+='<div class="cardFooter visualCardBox-cardFooter">',html+='<button is="paper-icon-button-light" class="itemAction btnCardOptions autoSize" data-action="menu"><i class="md-icon">more_horiz</i></button>',html+='<div class="cardText">'+device.FriendlyName+"</div>",html+='<div class="cardText cardText-secondary">',html+=device.Url||"&nbsp;",html+="</div>",html+="</div>",html+="</div>",html+="</div>"}function renderDevices(page,devices){var html=devices.map(getDeviceHtml).join("");page.querySelector(".devicesList").innerHTML=html}function deleteDevice(page,id){var message=globalize.translate("MessageConfirmDeleteTunerDevice");require(["confirm"],function(confirm){confirm(message,globalize.translate("HeaderDeleteDevice")).then(function(){loading.show(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("LiveTv/TunerHosts",{Id:id})}).then(function(){reload(page)})})})}function getListingProviders(){return ApiClient.getJSON(ApiClient.getUrl("LiveTv/ListingProviders")).catch(function(){return ApiClient.getNamedConfiguration("livetv").then(function(config){return config.ListingProviders})})}function getTunerDevices(){return ApiClient.getJSON(ApiClient.getUrl("LiveTv/TunerHosts")).catch(function(){return ApiClient.getNamedConfiguration("livetv").then(function(config){return config.TunerHosts})})}function reload(page){loading.show();var promises=[getListingProviders(),getTunerDevices()];Promise.all(promises).then(function(responses){var listingProviders=responses[0],tunerHosts=responses[1];renderDevices(page,tunerHosts),renderProviders(page,listingProviders)}),loading.hide()}function addParamToUrl(url,name,value){return-1===url.indexOf("?")?url+"?"+name+"="+value:url+"&"+name+"="+value}function renderProviders(page,providers){var html="";if(providers.length){html+='<div class="paperList">';for(var i=0,length=providers.length;i<length;i++){var provider=providers[i];html+='<div class="listItem">',html+='<i class="listItemIcon md-icon">dvr</i>',html+='<div class="listItemBody two-line">',provider.SetupUrl||(provider.SetupUrl="xmltv"===provider.Type?"livetvsetup/xmltv.html":"livetvsetup/schedulesdirect.html"),html+='<a is="emby-linkbutton" style="display:block;padding:0;margin:0;text-align:left;" class="clearLink" href="'+addParamToUrl(provider.SetupUrl,"id",provider.Id)+'">',html+='<h3 class="listItemBodyText">',html+=provider.Name||provider.Type,html+="</h3>",html+='<div class="listItemBodyText secondary">',html+=provider.Path||provider.ListingsId||"",html+="</div>",html+="</a>",html+="</div>",html+='<button type="button" is="paper-icon-button-light" class="btnOptions" data-id="'+provider.Id+'"><i class="md-icon listItemAside">more_horiz</i></button>',html+="</div>"}html+="</div>"}page.querySelector(".providerList").innerHTML=html}function showProviderOptions(page,providerId,button){var items=[];items.push({name:globalize.translate("ButtonDelete"),id:"delete"}),items.push({name:globalize.translate("MapChannels"),id:"map"}),require(["actionsheet"],function(actionsheet){actionsheet.show({items:items,positionTo:button}).then(function(id){switch(id){case"delete":deleteProvider(page,providerId);break;case"map":mapChannels(page,providerId)}})})}function mapChannels(page,providerId){require(["components/channelmapper/channelmapper"],function(channelmapper){new channelmapper({serverId:ApiClient.serverInfo().Id,providerId:providerId}).show()})}function deleteProvider(page,id){var message=globalize.translate("MessageConfirmDeleteGuideProvider");require(["confirm"],function(confirm){confirm(message,globalize.translate("HeaderDeleteProvider")).then(function(){loading.show(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("LiveTv/ListingProviders",{Id:id})}).then(function(){reload(page)},function(){reload(page)})})})}function addProvider(button){Dashboard.navigate("livetvsetup/guideprovider.html")}function addDevice(button){Dashboard.navigate("livetvsetup/livetvtuner.html")}function getTabs(){return[{href:"livetvsetup/livetvstatus.html",name:globalize.translate("TabDevices")},{href:"appservices.html?context=livetv",name:globalize.translate("TabServices")}]}function showDeviceMenu(button,tunerDeviceId){var items=[];items.push({name:globalize.translate("ButtonDelete"),id:"delete"}),items.push({name:globalize.translate("ButtonEdit"),id:"edit"}),require(["actionsheet"],function(actionsheet){actionsheet.show({items:items,positionTo:button}).then(function(id){switch(id){case"delete":deleteDevice(dom.parentWithClass(button,"page"),tunerDeviceId);break;case"edit":Dashboard.navigate("livetvsetup/livetvtuner.html?id="+tunerDeviceId)}})})}function onDevicesListClick(e){var card=dom.parentWithClass(e.target,"card");if(card){var id=card.getAttribute("data-id"),btnCardOptions=dom.parentWithClass(e.target,"btnCardOptions");btnCardOptions?showDeviceMenu(btnCardOptions,id):Dashboard.navigate("livetvsetup/livetvtuner.html?id="+id)}}return function(view,params){view.querySelector(".btnAddDevice").addEventListener("click",function(){addDevice(this)}),view.querySelector(".btnAddProvider").addEventListener("click",function(){addProvider(this)}),view.querySelector(".devicesList").addEventListener("click",onDevicesListClick),view.querySelector(".premiereInfo").innerHTML=globalize.translate("DvrSubscriptionRequired",'<a is="emby-linkbutton" href="https://emby.media/premiere" target="_blank" class="button-link">',"</a>"),view.querySelector(".providerList").addEventListener("click",function(e){var elemWithAttribute=dom.parentWithAttribute(e.target,"data-id");if(elemWithAttribute){var id=elemWithAttribute.getAttribute("data-id");showProviderOptions(view,id,elemWithAttribute)}}),view.addEventListener("viewshow",function(){libraryMenu.setTabs("livetvadmin",0,getTabs);var page=this;reload(page),taskButton({mode:"on",progressElem:page.querySelector(".refreshGuideProgress"),taskKey:"RefreshGuide",button:page.querySelector(".btnRefresh")})}),view.addEventListener("viewhide",function(){var page=this;taskButton({mode:"off",progressElem:page.querySelector(".refreshGuideProgress"),taskKey:"RefreshGuide",button:page.querySelector(".btnRefresh")})})}});