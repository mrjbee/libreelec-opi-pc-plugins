define(["jQuery","loading","globalize","dom","require","emby-checkbox","emby-select","emby-input","emby-button","emby-toggle"],function($,loading,globalize,dom,require){"use strict";function loadPage(page,config,codecs,defaultCodecConfigurations){var selectHwa=page.querySelector("#selectHwa");selectHwa.value=config.HardwareAccelerationMode||0;var codecConfigs=1===config.HardwareAccelerationMode?defaultCodecConfigurations:config.CodecConfigurations||[];renderCodecs(page,codecs,codecConfigs);Array.prototype.forEach.call(page.querySelectorAll(".chkEnableCodec"),function(c){var codecId=c.getAttribute("data-codec"),config=getConfigurationByCodecId(codecConfigs,codecId);c.checked=config&&config.IsEnabled}),page.querySelector("#chkEnableThrottle").checked=config.EnableThrottling,$("#selectThreadCount",page).val(config.EncodingThreadCount),$("#txtDownMixAudioBoost",page).val(config.DownMixAudioBoost),$("#txtTranscodingTempPath",page).val(config.TranscodingTempPath||""),$("#txtVaapiDevice",page).val(config.VaapiDevice||""),page.querySelector("#selectH264Preset").value=config.H264Preset||"",page.querySelector("#txtH264Crf").value=config.H264Crf||"0",page.querySelector("#chkEnableSubtitleExtraction").checked=config.EnableSubtitleExtraction||!1,onHwaModeChange.call(selectHwa),loading.hide(),bindEvents(page)}function renderCodecs(context,codecs,codecConfigs){if(null==codecs||0===codecs.length)return!1;applyPriorities(codecs,codecConfigs);var decoderHtml=renderCodecsGrouped(context,codecConfigs,codecs.filter(function(codec){return"Decoder"===codec.Direction&&codec.IsHardwareCodec})),encoderHtml=renderCodecsGrouped(context,codecConfigs,codecs.filter(function(codec){return"Encoder"===codec.Direction&&codec.IsHardwareCodec}));return context.querySelector("#hardwareDecoders").innerHTML=decoderHtml,context.querySelector("#hardwareEncoders").innerHTML=encoderHtml,!0}function renderCodecsGrouped(context,codecConfigs,codecs){return codecs.map(function(item){return item.MediaTypeName}).filter(distinct).map(function(group){var groupCodecs=codecs.filter(function(codec){return codec.MediaTypeName===group});return renderCodecGroup(context,group,groupCodecs)}).join("")}function renderCodecGroup(context,group,codecs){codecs.sort(function(c1,c2){return c2.Priority-c1.Priority});var html='<div><h3 class="checkboxListLabel">'+group+"</h3>";return html+='<div class="checkboxList paperList checkboxList-paperList">',html+=codecs.map(renderSingleCodec).join(""),html+="</div></div>"}function renderSingleCodec(codec,index,codecs){var checkBoxHtml='<label class="listItemCheckboxContainer">';checkBoxHtml+='<input type="checkbox" is="emby-checkbox" class="chkEnableCodec"  data-codec="'+codec.Id+'" />',checkBoxHtml+="<span>"+codec.Name+"</span></label>";var contentHtml='<div class="listItemBody two-line listItemBodyText">';contentHtml+="</div>";var upDownHtml="";index>0?upDownHtml+='<button type="button" is="paper-icon-button-light" title="'+globalize.translate("ButtonUp")+'" class="listItemButton btnSortableMoveUp btnSortable" data-pluginindex="'+codec.Id+'"><i class="md-icon">keyboard_arrow_up</i></button>':codecs.length>1&&(upDownHtml+='<button type="button" is="paper-icon-button-light" title="'+globalize.translate("ButtonDown")+'" class="listItemButton btnSortableMoveDown btnSortable" data-pluginindex="'+codec.Id+'"><i class="md-icon">keyboard_arrow_down</i></button>');var itemBorder=index<codecs.length-1?" listItem-border ":"",fullHtml='<div class="listItem '+itemBorder+' sortableOption">';return fullHtml+=checkBoxHtml,fullHtml+=contentHtml,fullHtml+="",fullHtml+=upDownHtml,fullHtml+="</div>"}function onSubmit(){var form=this;return loading.show(),ApiClient.getNamedConfiguration("encoding").then(function(config){config.DownMixAudioBoost=$("#txtDownMixAudioBoost",form).val(),config.TranscodingTempPath=$("#txtTranscodingTempPath",form).val(),config.EncodingThreadCount=$("#selectThreadCount",form).val(),config.VaapiDevice=$("#txtVaapiDevice",form).val(),config.H264Preset=form.querySelector("#selectH264Preset").value,config.H264Crf=parseInt(form.querySelector("#txtH264Crf").value||"0"),config.EnableSubtitleExtraction=form.querySelector("#chkEnableSubtitleExtraction").checked,config.EnableThrottling=form.querySelector("#chkEnableThrottle").checked;var selectHwa=form.querySelector("#selectHwa");config.HardwareAccelerationMode=parseInt(selectHwa.value);var codecConfigs=[];2===config.HardwareAccelerationMode&&Array.prototype.forEach.call(form.querySelectorAll(".chkEnableCodec"),function(c){var priority=c.checked?100-getCodecListIndex(c):0,codecId=c.getAttribute("data-codec"),codecConfig={CodecId:codecId,Priority:priority,IsEnabled:c.checked};codecConfigs.push(codecConfig)}),config.HardwareAccelerationType=null,config.CodecConfigurations=codecConfigs,ApiClient.updateNamedConfiguration("encoding",config).then(function(){loading.hide(),Dashboard.processServerConfigurationUpdateResult()})}),!1}function getConfigurationByCodecId(codecConfigs,codecId){if(!codecId||null==codecConfigs||0===codecConfigs.length)return null;for(var i=0;i<codecConfigs.length;i++)if(codecConfigs[i]&&codecConfigs[i].CodecId&&codecConfigs[i].CodecId===codecId)return codecConfigs[i];return null}function getCodecListIndex(checkBox){for(var li=dom.parentWithClass(checkBox,"sortableOption"),index=0;li=li.previousElementSibling;)index++;return index}function applyPriorities(codecs,codecConfigs){for(var i=0,length=codecs.length;i<length;i++){var codec=codecs[i],config=getConfigurationByCodecId(codecConfigs,codec.Id);config&&config.Priority?codec.Priority=config.Priority:codec.Priority=0}}function distinct(value,index,self){return self.indexOf(value)===index}function bindEvents(page){page.querySelector("#hardwareDecoders").addEventListener("click",onCodecClick),page.querySelector("#hardwareEncoders").addEventListener("click",onCodecClick)}function onCodecClick(e){var btnSortable=dom.parentWithClass(e.target,"btnSortable");if(btnSortable){var li=dom.parentWithClass(btnSortable,"sortableOption"),list=dom.parentWithClass(li,"paperList");if(btnSortable.classList.contains("btnSortableMoveDown")){var next=li.nextElementSibling;next&&(li.parentNode.removeChild(li),next.parentNode.insertBefore(li,next.nextElementSibling))}else{var prev=li.previousElementSibling;prev&&(li.parentNode.removeChild(li),prev.parentNode.insertBefore(li,prev))}Array.prototype.forEach.call(list.querySelectorAll(".sortableOption"),adjustSortableListElement)}}function adjustSortableListElement(elem){var btnSortable=elem.querySelector(".btnSortable");elem.previousElementSibling?(btnSortable.classList.add("btnSortableMoveUp"),btnSortable.classList.remove("btnSortableMoveDown"),btnSortable.querySelector("i").innerHTML="keyboard_arrow_up"):(btnSortable.classList.remove("btnSortableMoveUp"),btnSortable.classList.add("btnSortableMoveDown"),btnSortable.querySelector("i").innerHTML="keyboard_arrow_down"),elem.nextElementSibling?elem.classList.add("listItem-border"):elem.classList.remove("listItem-border")}function onHwaModeChange(e){for(var select=this,view=dom.parentWithClass(select,"page"),advancedSections=view.querySelectorAll(".hwaAdvanced"),mode=select.value,i=0,length=advancedSections.length;i<length;i++)"2"===mode?advancedSections[i].classList.remove("hide"):advancedSections[i].classList.add("hide")}function onHwaPremiereClick(){require(["registrationServices"],function(registrationServices){registrationServices.validateFeature("themes",{viewOnly:!0,showDialog:!0}).then(function(){Dashboard.navigate("supporterkey.html")})})}return function(view,params){view.querySelector("#selectHwa").addEventListener("change",onHwaModeChange),$("#btnSelectTranscodingTempPath",view).on("click.selectDirectory",function(){require(["directorybrowser"],function(directoryBrowser){var picker=new directoryBrowser;picker.show({callback:function(path){path&&$("#txtTranscodingTempPath",view).val(path),picker.close()},validateWriteable:!0,header:globalize.translate("HeaderSelectTranscodingPath"),instruction:globalize.translate("HeaderSelectTranscodingPathHelp")})})}),$(".encodingSettingsForm").off("submit",onSubmit).on("submit",onSubmit),ApiClient.getSystemInfo().then(function(systemInfo){var hwaPremiereInfo=view.querySelector(".hwaPremiereInfo");systemInfo.HardwareAccelerationRequiresPremiere?hwaPremiereInfo.classList.remove("hide"):hwaPremiereInfo.classList.add("hide"),hwaPremiereInfo.innerHTML=globalize.translate("FeatureRequiresEmbyPremiere",'<button is="emby-button" type="button" class="button-link btnHwaPremiere">',"</button>");var btnHwaPremiere=hwaPremiereInfo.querySelector(".btnHwaPremiere");btnHwaPremiere&&btnHwaPremiere.addEventListener("click",onHwaPremiereClick)}),view.addEventListener("viewshow",function(){loading.show();var page=this,configPromise=ApiClient.getNamedConfiguration("encoding"),codecInfoPromise=ApiClient.getVideoCodecInformation().catch(function(){return[]}),codecConfigDefaults=ApiClient.getJSON(ApiClient.getUrl("Encoding/CodecConfiguration/Defaults")).catch(function(){return[]});Promise.all([configPromise,codecInfoPromise,codecConfigDefaults]).then(function(responses){loadPage(page,responses[0],responses[1],responses[2])})})}});